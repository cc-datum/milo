apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: organizationmembership-fieldselector
spec:
  clusters:
    org:
      kubeconfig: kubeconfig-org-template
  steps:
  - name: setup
    try:
    - apply:
        file: resources/org.yaml
    - wait:
        apiVersion: v1
        kind: Namespace
        name: organization-fieldsel-org
        timeout: 60s
        for:
          jsonPath:
            path: '{.status.phase}'
            value: Active
    - apply:
        file: resources/user-1001.yaml
    - apply:
        file: resources/user-1002.yaml
    - apply:
        file: resources/membership-1001.yaml
    - apply:
        file: resources/membership-1002.yaml
    - wait:
        apiVersion: resourcemanager.miloapis.com/v1alpha1
        kind: OrganizationMembership
        name: m-1001
        namespace: organization-fieldsel-org
        timeout: 60s
        for:
          condition:
            name: Ready
            value: 'True'

  - name: direct-field-selector-on-org-cluster
    cluster: org
    try:
    - script:
        timeout: 60s
        content: |
          set -euo pipefail
          # spec.userRef.name filter matches exactly one
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.userRef.name=1001 -o json | jq '.items | length')" -eq 1
          # non-matching user yields zero
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.userRef.name=does-not-exist -o json | jq '.items | length')" -eq 0
          # organization filter matches both memberships
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.organizationRef.name=fieldsel-org -o json | jq '.items | length')" -eq 2

  - name: org-scoped-fieldselector-behavior
    cluster: org
    try:
    - script:
        timeout: 60s
        content: |
          set -euo pipefail
          # Plain list returns both memberships
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org -o json | jq '.items | length')" -eq 2
          # Field-select by user narrows the list
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.userRef.name=1002 -o json | jq '.items | length')" -eq 1

  - name: cleanup
    finally:
    - delete:
        file: resources/membership-1001.yaml
    - delete:
        file: resources/membership-1002.yaml
    - delete:
        file: resources/user-1001.yaml
    - delete:
        file: resources/user-1002.yaml
    - delete:
        file: resources/org.yaml


